-- TYP KOMPETENCJI
CREATE TABLE TYPY_KOMPETENCJI
(
    ID_TYPU_KOMPETENCJI  NUMBER(2) GENERATED BY DEFAULT AS IDENTITY ( START WITH 1 INCREMENT BY 1 CACHE 2),
    NAZWA                VARCHAR2(60) NOT NULL,
    URZAD_STANDARYZUJACY VARCHAR2(100),
    WERSJA_STANDARDU     VARCHAR2(20)
);

ALTER TABLE TYPY_KOMPETENCJI
    ADD CONSTRAINT typy_komp_pk PRIMARY KEY (ID_TYPU_KOMPETENCJI);
ALTER TABLE TYPY_KOMPETENCJI
    ADD CONSTRAINT typy_komp_nazwa_uk UNIQUE (NAZWA);


-- STOPIEN
CREATE TABLE STOPNIE
(
    ID_TYPU_KOMPETENCJI NUMBER(2) NOT NULL,
    NR_PORZADKOWY       NUMBER(2) GENERATED BY DEFAULT AS IDENTITY ( START WITH 1 INCREMENT BY 1 CACHE 2),
    KOD                 VARCHAR2(20)
);
ALTER TABLE STOPNIE
    ADD CONSTRAINT stop_pk PRIMARY KEY (ID_TYPU_KOMPETENCJI, NR_PORZADKOWY);
ALTER TABLE STOPNIE
    ADD CONSTRAINT stop_typy_komp_fk FOREIGN KEY (ID_TYPU_KOMPETENCJI)
        REFERENCES TYPY_KOMPETENCJI (ID_TYPU_KOMPETENCJI) DEFERRABLE INITIALLY DEFERRED;

COMMENT ON COLUMN STOPNIE.NR_PORZADKOWY IS 'Kolejność w hierarchii.';
COMMENT ON TABLE STOPNIE IS 'Określenie hierarchii w skalach stopniowania kompetencji różnych typów.';


-- KLASYFIKACJA KOMPETENCJI
CREATE TABLE KLASYFIKACJE_KOMPETENCJI
(
    ID_TYPU_KOMPETENCJI NUMBER(2)    NOT NULL,
    NR_PORZADKOWY       NUMBER(5) GENERATED BY DEFAULT AS IDENTITY ( START WITH 1 INCREMENT BY 1 CACHE 2),
    KOD                 VARCHAR2(20) NOT NULL,
    NAZWA               VARCHAR2(60) NOT NULL
);

ALTER TABLE KLASYFIKACJE_KOMPETENCJI
    ADD CONSTRAINT klas_komp_pk PRIMARY KEY (ID_TYPU_KOMPETENCJI, NR_PORZADKOWY);
ALTER TABLE KLASYFIKACJE_KOMPETENCJI
    ADD CONSTRAINT klas_komp_typy_komp_fk FOREIGN KEY (ID_TYPU_KOMPETENCJI)
        REFERENCES TYPY_KOMPETENCJI (ID_TYPU_KOMPETENCJI) DEFERRABLE INITIALLY DEFERRED;

COMMENT ON TABLE KLASYFIKACJE_KOMPETENCJI IS 'Określenie konkretnej klasyfikacji kompetencji (np. "język angielski" w typie kompetencji językowej).';

-- KOMPETENCJA
CREATE TYPE KOMPETENCJA_T AS OBJECT
(
    ID_KOMPETENCJI             NUMBER(5),
    NAZWA                      VARCHAR2(60),
    ID_TYPU_KOMPETENCJI        NUMBER(2),
    NR_PORZADKOWY_KLASYFIKACJI NUMBER(5),
    NR_PORZADKOWY_STOPNIA      NUMBER(2),
    OPIS                       VARCHAR2(100),
    MAP MEMBER FUNCTION lp_stopnia RETURN NUMBER
) NOT INSTANTIABLE NOT FINAL;
/

CREATE TYPE BODY KOMPETENCJA_T AS
    MAP MEMBER FUNCTION lp_stopnia RETURN NUMBER IS
    BEGIN
        RETURN NR_PORZADKOWY_STOPNIA;
    END lp_stopnia;
END;
/

CREATE TABLE KOMPETENCJE OF KOMPETENCJA_T;

ALTER TABLE KOMPETENCJE
    ADD CONSTRAINT komp_pk PRIMARY KEY (ID_KOMPETENCJI);
ALTER TABLE KOMPETENCJE
    ADD CONSTRAINT nazwa_not_null_ck CHECK (NAZWA IS NOT NULL);
ALTER TABLE KOMPETENCJE
    ADD CONSTRAINT id_typu_komp_not_null_ck CHECK (ID_TYPU_KOMPETENCJI IS NOT NULL);
ALTER TABLE KOMPETENCJE
    ADD CONSTRAINT nr_porzadkowy_stopnia_not_null_ck CHECK (NR_PORZADKOWY_STOPNIA IS NOT NULL);
ALTER TABLE KOMPETENCJE
    ADD CONSTRAINT nr_porzadkowy_klasyfikacji_not_null_ck CHECK (NR_PORZADKOWY_KLASYFIKACJI IS NOT NULL);
ALTER TABLE KOMPETENCJE
    ADD CONSTRAINT komp_nazwa_uk UNIQUE (NAZWA);
ALTER TABLE KOMPETENCJE
    ADD CONSTRAINT komp_klas_komp_fk FOREIGN KEY (ID_TYPU_KOMPETENCJI, NR_PORZADKOWY_KLASYFIKACJI)
        REFERENCES KLASYFIKACJE_KOMPETENCJI (ID_TYPU_KOMPETENCJI, NR_PORZADKOWY) DEFERRABLE INITIALLY DEFERRED;
ALTER TABLE KOMPETENCJE
    ADD CONSTRAINT komp_stop_fk FOREIGN KEY (ID_TYPU_KOMPETENCJI, NR_PORZADKOWY_STOPNIA)
        REFERENCES STOPNIE (ID_TYPU_KOMPETENCJI, NR_PORZADKOWY) DEFERRABLE INITIALLY DEFERRED;
ALTER TABLE KOMPETENCJE
    ADD CONSTRAINT komp_typu_komp_fk FOREIGN KEY (ID_TYPU_KOMPETENCJI)
        REFERENCES TYPY_KOMPETENCJI (ID_TYPU_KOMPETENCJI) DEFERRABLE INITIALLY DEFERRED;

CREATE INDEX komp_klas_komp_fk_idx ON KOMPETENCJE (ID_TYPU_KOMPETENCJI ASC,
                                                   NR_PORZADKOWY_KLASYFIKACJI ASC);
CREATE INDEX komp_stop_fk_idx ON KOMPETENCJE (ID_TYPU_KOMPETENCJI ASC, NR_PORZADKOWY_STOPNIA
                                              ASC);


-- KOMPETENCJA PROSTA
CREATE TYPE KOMPETENCJA_PROSTA_T UNDER KOMPETENCJA_T
(
);
/


-- KOMPETENCJA Z WYMAGANIAMI
CREATE TYPE LISTA_WYMAGANYCH_KOMP_T AS TABLE OF REF KOMPETENCJA_T;
/
CREATE TYPE KOMPETENCJA_Z_WYMAGANIAMI_T UNDER KOMPETENCJA_T
(
    MINIMALNA_LICZBA_SPELNIONYCH NUMBER(2),
    WYMAGANE_KOMPETENCJE LISTA_WYMAGANYCH_KOMP_T
);
/

ALTER TABLE KOMPETENCJE
    ADD CONSTRAINT komp_z_wyma_mini_licz_spel_not_null_ck CHECK (SYS_TYPEID(OBJECT_VALUE) <> HEXTORAW(3) OR
                                                                 TREAT(OBJECT_VALUE AS KOMPETENCJA_Z_WYMAGANIAMI_T).MINIMALNA_LICZBA_SPELNIONYCH IS NOT NULL);
ALTER TABLE KOMPETENCJE
    ADD CONSTRAINT komp_z_wyma_mini_licz_spel_gt_0_ck CHECK (SYS_TYPEID(OBJECT_VALUE) <> HEXTORAW(3) OR
                                                             TREAT(OBJECT_VALUE AS KOMPETENCJA_Z_WYMAGANIAMI_T).MINIMALNA_LICZBA_SPELNIONYCH >
                                                             0);
ALTER TABLE KOMPETENCJE
    ADD CONSTRAINT komp_z_wyma_wymagane_komp_not_null_ck CHECK (SYS_TYPEID(OBJECT_VALUE) <> HEXTORAW(3) OR
                                                             TREAT(OBJECT_VALUE AS KOMPETENCJA_Z_WYMAGANIAMI_T).WYMAGANE_KOMPETENCJE IS NOT NULL);

-- KOMPETENCJA ZLOZONA
CREATE TYPE LISTA_KOMP_PODRZEDNYCH_T AS TABLE OF REF KOMPETENCJA_T;
/

CREATE TYPE KOMPETENCJA_ZLOZONA_T UNDER KOMPETENCJA_T
(
    KOMPETENCJE_PODRZEDNE LISTA_KOMP_PODRZEDNYCH_T
);
/

ALTER TABLE KOMPETENCJE
    ADD CONSTRAINT komp_zlozaona_list_komp_podrz_not_null_ck CHECK (SYS_TYPEID(OBJECT_VALUE) <> HEXTORAW(4) OR
                                                                    TREAT(OBJECT_VALUE AS KOMPETENCJA_ZLOZONA_T).KOMPETENCJE_PODRZEDNE IS NOT NULL);

COMMENT ON TABLE KOMPETENCJE  IS 'W celu uzycia calego obiektu znajdujacego sie w sprawdzanym wierszu w ograniczeniach CHECK wykorzystano pseudo kolumne OBJECT_VALUE. W każdym ograniczeniu w pierwszym warunku porownywany jest identyfikator typu obiektu z odpowiednim typem podklasy KOMPETENCJA_T. Ograniczenia sprawdzajace czy atrybuty podklas nie sa NULL, maja na celu, aby obiekty podklas rozszerzjacych KOMPETENCJA_T roznily sie od podklasy KOMPETENCJA_PROSTA (jezeli te atrybuty sa NULL to powinien byc utworzony obiekt klasy KOMPETENCJA_PROSTA, a nie innej podklasy)';


--PRACOWNIK
CREATE TYPE LISTA_POSIADANYCH_KOMPETENCJI_T AS TABLE OF REF KOMPETENCJA_T;
/

CREATE TYPE PRACOWNIK_T AS OBJECT
(
    ID_PRACOWNIKA         NUMBER(4),
    IMIE                  VARCHAR(30),
    NAZWISKO              VARCHAR(50),
    DATA_URODZENIA        DATE,
    PESEL                 CHAR(11 CHAR),
    IBAN                  VARCHAR(33),
    POSIADANE_KOMPETENCJE LISTA_POSIADANYCH_KOMPETENCJI_T
);

CREATE TABLE PRACOWNICY OF PRACOWNIK_T NESTED TABLE POSIADANE_KOMPETENCJE STORE AS POSIADANE_KOMPETENCJE_NT;

ALTER TABLE PRACOWNICY
    ADD CONSTRAINT prac_pk PRIMARY KEY (ID_PRACOWNIKA);
ALTER TABLE PRACOWNICY
    ADD CONSTRAINT prac_pesel_uk UNIQUE (PESEL);
ALTER TABLE PRACOWNICY
    MODIFY IMIE NOT NULL;
ALTER TABLE PRACOWNICY
    MODIFY NAZWISKO NOT NULL;
ALTER TABLE PRACOWNICY
    MODIFY DATA_URODZENIA NOT NULL;
ALTER TABLE PRACOWNICY
    ADD CONSTRAINT prac_pesel_regex_check CHECK (regexp_like(PESEL, '[0-9]{4}[0-3][0-9][0-9]{5}'));
ALTER TABLE PRACOWNICY
    ADD CONSTRAINT prac_iban_regex_check CHECK (regexp_like(IBAN, '[A-Z]{2}[0-9]{2}[A-Z0-9]{1,30}'));